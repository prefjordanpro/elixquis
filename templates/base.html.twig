{# templates/base.html.twig #}
<!doctype html>
<html lang="fr" data-bs-theme="auto">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Elixquis - Le rhum 100% Made in France</title>
<meta name="description" content="Elixquis le rhum Made In France">

{# Applique le thème choisi (ou auto) AVANT le chargement des CSS pour éviter le flash #}
<script>
(() => {
    try {
    const saved = localStorage.getItem('theme') || 'auto';
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const effective = (saved === 'auto') ? (prefersDark ? 'dark' : 'light') : saved;
    document.documentElement.setAttribute('data-bs-theme', effective);
    } catch(e) {}
})();
</script>

{# CSS: Bootstrap d'abord, puis tes feuilles pour pouvoir les surcharger #}
<link href="{{ asset('assets/css/bootstrap.min.css') }}" rel="stylesheet">
<link rel="stylesheet" href="{{ asset('assets/css/style.css') }}?v=1">
<link href="{{ asset('assets/css/carousel.css') }}?v=1" rel="stylesheet">
<link href="{{ asset('assets/css/custom.css') }}?v=3" rel="stylesheet">

{# Feather Icons #}
<script src="https://unpkg.com/feather-icons"></script>
</head>
<body>

<header data-bs-theme="dark">
<nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
    <div class="container-fluid">
    <a class="navbar-brand" href="{{ path('app_home') }}">Elixquis</a>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse"
            aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarCollapse">
        <ul class="navbar-nav me-auto mb-2 mb-md-0">
        <li class="nav-item">
            <a class="nav-link active" aria-current="page" href="{{ path('app_home') }}">Accueil</a>
        </li>
        {% for category in allCategories %}
            <li class="nav-item">
            <a class="nav-link" href="{{ path('app_category', { slug : category.slug } ) }}">{{ category.name }}</a>
            </li>
        {% endfor %}
        </ul>

        <div class="d-flex align-items-center gap-3">
        <div class="speed-menu d-flex align-items-center gap-3">
            {% if app.user %}
            <a href="{{ path('app_account') }}" class="text-decoration-none">
                <i data-feather="user"></i> {{ app.user.firstname }}
            </a>
            {% else %}
            <a href="{{ path('app_login') }}" class="text-decoration-none">
                <i data-feather="user"></i>
            </a>
            {% endif %}

            <a href="{{ path ('app_cart') }}" class="text-decoration-none position-relative">
            <i data-feather="shopping-cart"></i>
            <span class="badge text-bg-light">{{ fullCartQuantity }}</span>
            </a>
        </div>

        {# Sélecteur de thème #}
        <div class="dropdown">
            <button class="btn btn-sm btn-outline-light dropdown-toggle d-flex align-items-center gap-2"
                    type="button" id="themeDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            <i data-feather="sun"></i><span>Thème</span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="themeDropdown">
            <li>
                <button type="button" class="dropdown-item d-flex align-items-center gap-2" data-theme-value="light">
                <i data-feather="sun"></i> Clair
                </button>
            </li>
            <li>
                <button type="button" class="dropdown-item d-flex align-items-center gap-2" data-theme-value="dark">
                <i data-feather="moon"></i> Sombre
                </button>
            </li>
            <li>
                <button type="button" class="dropdown-item d-flex align-items-center gap-2" data-theme-value="auto">
                <i data-feather="monitor"></i> Auto (système)
                </button>
            </li>
            </ul>
        </div>
        </div>

    </div>
    </div>
</nav>
</header>

<main>
<div class="container">
    {% for label, messages in app.flashes %}
    {% for message in messages %}
        <div class="alert mt-4 alert-{{ label }}">
        {{ message }}
        </div>
    {% endfor %}
    {% endfor %}
</div>

{% block body %}{% endblock %}

<footer class="container my-5">
    <p class="mb-0">&copy; 2025 Elixquis
    <a href="#">CGV</a> &middot; <a href="#">CGU</a>
    </p>
</footer>
</main>

{# JS #}
<script src="{{ asset('assets/js/bootstrap.bundle.min.js') }}"></script>
<script src="{{ asset('assets/js/global.js') }}"></script>

{# Activation feather + gestion sélecteur de thème #}
<script>
(function () {
const storageKey = 'theme';
const mql = window.matchMedia('(prefers-color-scheme: dark)');

function resolveTheme(value) {
    if (value === 'auto') return mql.matches ? 'dark' : 'light';
    return value; // 'light' | 'dark'
}

function setTheme(value) {
    try {
    localStorage.setItem(storageKey, value);
    } catch(e) {}
    document.documentElement.setAttribute('data-bs-theme', resolveTheme(value));
    updateActive(value);
    if (window.feather) feather.replace();
}

function updateActive(value) {
    document.querySelectorAll('[data-theme-value]').forEach(btn => {
    btn.classList.toggle('active', btn.getAttribute('data-theme-value') === value);
    });
}

function initThemeSwitcher() {
    const saved = localStorage.getItem(storageKey) || 'auto';
    updateActive(saved);

    document.querySelectorAll('[data-theme-value]').forEach(btn => {
    btn.addEventListener('click', () => setTheme(btn.getAttribute('data-theme-value')));
    });

    const onChange = () => {
    const current = localStorage.getItem(storageKey) || 'auto';
    if (current === 'auto') {
        document.documentElement.setAttribute('data-bs-theme', resolveTheme('auto'));
        if (window.feather) feather.replace();
    }
    };
    if (typeof mql.addEventListener === 'function') {
    mql.addEventListener('change', onChange);
    } else if (typeof mql.addListener === 'function') {
    mql.addListener(onChange); // Safari anciens
    }
}

document.addEventListener('DOMContentLoaded', () => {
    if (window.feather) feather.replace();
    initThemeSwitcher();
});
})();
</script>

</body>
</html>
