{# templates/admin/order.html.twig #}
{% set order = (entity.instance is defined) ? entity.instance : ea.entity.instance %}
{% set crud  = 'App\\\\Controller\\\\Admin\\\\OrderCrudController' %}

{% macro euro(x) %}{{ (x|default(0))|number_format(2, ',', ' ') }} ‚Ç¨{% endmacro %}
{% import _self as ui %}

{% set labels = {
  0: ['En attente de paiement','badge bg-secondary'],
  1: ['Pay√©e','badge bg-success'],
  2: ['En pr√©paration','badge bg-warning text-dark'],
  3: ['Exp√©di√©e','badge bg-primary'],
  4: ['Annul√©e','badge bg-danger']
} %}

{# --- En-t√™te + actions --- #}
{% set badge = labels[order.state|default(0)]|default(['Statut inconnu','badge bg-secondary']) %}
<div class="d-flex flex-wrap justify-content-between align-items-start mb-3">
  <div class="me-3">
    <div class="mb-1"><span class="{{ badge[1] }}">{{ badge[0] }}</span></div>
    <div class="mb-1">
      Stripe Session ID : {{ order.stripeSessionId }}
      <strong>#{{ order.id }}</strong> ‚Äî {{ order.createdAt|date('d/m/Y H:i') }}
    </div>
    {% if order.user %}
      <div>Client : <strong>{{ order.user.firstname|default('') }} {{ order.user.lastname|default('') }}</strong></div>
    {% endif %}
  </div>

  <div class="d-flex gap-2">
    <a target="_blank"
      href="{{ path('app_invoice_admin', { id_order : order.id }) }}"
      class="btn btn-primary btn-sm rounded-pill">
      Facture
    </a>
  </div>
</div>

{# --- Adresse de livraison (affichage clair) --- #}
<div class="mb-3">
  <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
    <h5 class="mb-0">Adresse de livraison</h5>
    <div class="d-flex gap-2">
      {% if order.carrierName %}
        <span class="badge rounded-pill text-bg-secondary">Transporteur : {{ order.carrierName }}</span>
      {% endif %}
      <span class="badge rounded-pill text-bg-primary">Commande n¬∞ {{ order.id }}</span>
    </div>
  </div>

  <div class="p-3 bg-light rounded-3 border">
    <div class="row g-3">
      <div class="col-sm-6 col-lg-4">
        <div class="text-muted small">Nom</div>
        <div class="fw-semibold">{{ order.user ? order.user.lastname : '‚Äî' }}</div>
      </div>
      <div class="col-sm-6 col-lg-4">
        <div class="text-muted small">Pr√©nom</div>
        <div class="fw-semibold">{{ order.user ? order.user.firstname : '‚Äî' }}</div>
      </div>
      <div class="col-12">
        <div class="text-muted small">Adresse</div>
        <div class="fw-semibold">
          {% if order.delivery %}
            {{ order.delivery|raw }} {# garde les <br> si pr√©sents #}
          {% else %}
            ‚Äî
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>


{# ===================== LIGNES PRODUITS (responsive) ===================== #}
<div class="table-responsive">
  <table class="table table-sm align-middle mb-0">
    <thead class="table-light">
      <tr>
        <th style="width:56px;"></th>
        <th>Produit</th>
        <th class="text-center" style="width:90px;">Qt√©</th>

        {# PU TTC masqu√© en < lg pour simplifier le mobile #}
        <th class="text-end d-none d-lg-table-cell" style="width:110px;">PU TTC</th>

        {# colonnes visibles seulement ‚â• lg #}
        <th class="text-end d-none d-lg-table-cell" style="width:110px;">PU HT</th>
        <th class="text-end d-none d-lg-table-cell" style="width:80px;">TVA</th>
        <th class="text-end d-none d-lg-table-cell" style="width:110px;">Ligne HT</th>
        <th class="text-end d-none d-lg-table-cell" style="width:110px;">Ligne TVA</th>

        <th class="text-end" style="width:110px;">Ligne TTC</th>
      </tr>
    </thead>
    <tbody>
      {% set total_ht = 0 %}
      {% set total_tva = 0 %}

      {% for d in order.orderDetails %}
        {% set q    = d.productQuantity|default(0) %}
        {% set put  = d.productPrice|default(0) %}        {# PU TTC stock√© (m√™me unit√© que ailleurs) #}
        {% set tvaP = d.productTva|default(0) %}
        {% set coef = 1 + (tvaP/100) %}
        {% set puh  = (coef > 0) ? (put / coef) : put %}  {# PU HT recalcul√© #}
        {% set lht  = puh * q %}
        {% set lttc = put * q %}
        {% set ltv  = lttc - lht %}
        {% set total_ht  = total_ht + lht %}
        {% set total_tva = total_tva + ltv %}

        <tr>
          <td>
            {% if d.productIllustration %}
              <img src="{{ asset('uploads/' ~ d.productIllustration) }}" alt=""
                  class="rounded" style="width:48px;height:48px;object-fit:cover">
            {% else %}
              <div class="rounded border bg-light d-flex align-items-center justify-content-center"
                  style="width:48px;height:48px;">üõçÔ∏è</div>
            {% endif %}
          </td>

          <td>
            <div class="fw-semibold">{{ d.productName|default('Produit') }}</div>

            {# r√©sum√© mobile < lg : l√©ger et sans doublons #}
            <div class="d-lg-none small text-muted mt-1">
              TVA {{ tvaP }}% ¬∑ PU HT {{ ui.euro(puh) }}
            </div>
          </td>

          <td class="text-center">{{ q }}</td>
          <td class="text-end d-none d-lg-table-cell">{{ ui.euro(put) }}</td>

          {# colonnes desktop #}
          <td class="text-end d-none d-lg-table-cell">{{ ui.euro(puh) }}</td>
          <td class="text-end d-none d-lg-table-cell">{{ tvaP }}%</td>
          <td class="text-end d-none d-lg-table-cell">{{ ui.euro(lht) }}</td>
          <td class="text-end d-none d-lg-table-cell">{{ ui.euro(ltv) }}</td>

          <td class="text-end fw-semibold">{{ ui.euro(lttc) }}</td>
        </tr>
      {% else %}
        <tr><td colspan="9" class="text-center text-muted py-4">Aucune ligne</td></tr>
      {% endfor %}

      {# ===================== LIGNE TRANSPORTEUR ===================== #}
      {% set carrier_rate = (order.carrierTvaRate is defined and order.carrierTvaRate is not null)
          ? order.carrierTvaRate
          : ((order.carrierTva is defined and order.carrierTva is not null) ? order.carrierTva : 0) %}
      {% set carrier_coef = 1 + (carrier_rate/100) %}
      {% set carrier_put  = order.carrierPrice|default(0) %}          {# TTC #}
      {% set carrier_puh  = (carrier_coef > 0) ? (carrier_put / carrier_coef) : carrier_put %}
      {% set carrier_lht  = carrier_puh %}                            {# Qt√© = 1 #}
      {% set carrier_lttc = carrier_put %}
      {% set carrier_ltv  = carrier_lttc - carrier_lht %}

      {% if carrier_put > 0 %}
        <tr class="table-light">
          <td>
            <div class="rounded border bg-light d-flex align-items-center justify-content-center"
                style="width:48px;height:48px;">üöö</div>
          </td>
          <td>
            <div class="fw-semibold">{{ order.carrierName|default('Transporteur') }}</div>
            <div class="d-lg-none small text-muted mt-1">
              TVA {{ carrier_rate }}% ¬∑ PU HT {{ ui.euro(carrier_puh) }}
            </div>
          </td>
          <td class="text-center">1</td>
          <td class="text-end d-none d-lg-table-cell">{{ ui.euro(carrier_put) }}</td>

          <td class="text-end d-none d-lg-table-cell">{{ ui.euro(carrier_puh) }}</td>
          <td class="text-end d-none d-lg-table-cell">{{ carrier_rate }}%</td>
          <td class="text-end d-none d-lg-table-cell">{{ ui.euro(carrier_lht) }}</td>
          <td class="text-end d-none d-lg-table-cell">{{ ui.euro(carrier_ltv) }}</td>

          <td class="text-end fw-semibold">{{ ui.euro(carrier_lttc) }}</td>
        </tr>
      {% endif %}
    </tbody>
  </table>
</div>

{# ===================== R√âCAP TOTAUX + Annuler ===================== #}
{% set livraison_ttc = order.carrierPrice|default(0) %}
{# total_ttc_cmd : si order.totalWt existe, on le respecte ; sinon on recompose #}
{% set total_ttc_cmd = order.totalWt|default(total_ht + total_tva + livraison_ttc) %}

<div class="row mt-3 g-3">
  <div class="col-12 col-lg-6 order-2 order-lg-1">
    {# zone libre (note, tracking, etc.) #}
  </div>

  <div class="col-12 col-lg-6 order-1 order-lg-2">
    <div class="table-responsive">
      <table class="table table-sm mb-2">
        <tbody>
          <tr>
            <th class="text-end w-50">Sous-total HT (articles)</th>
            <td class="text-end">{{ ui.euro(total_ht) }}</td>
          </tr>
          <tr>
            <th class="text-end">TVA (articles)</th>
            <td class="text-end">{{ ui.euro(total_tva) }}</td>
          </tr>
          <tr>
            <th class="text-end">Livraison TTC</th>
            <td class="text-end">{{ ui.euro(livraison_ttc) }}</td>
          </tr>
        </tbody>
        <tfoot>
          <tr class="table-light">
            <th class="text-end">Total TTC</th>
            <th class="text-end">{{ ui.euro(total_ttc_cmd) }}</th>
          </tr>
        </tfoot>
      </table>
    </div>

    {% if order.state < 3 %}
      <div class="d-flex justify-content-lg-end">
        <a class="btn btn-outline-danger"
          onclick="return confirm('Confirmer l\\'annulation de la commande #{{ order.id }} ?');"
          href="{{ ea_url().setController(crud).setAction('toCanceled').setEntityId(order.id) }}">
          Annuler la commande
        </a>
      </div>
    {% endif %}
  </div>
</div>
